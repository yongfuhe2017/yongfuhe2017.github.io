---
category: db
published: false
layout: post
title: postgresql 学习笔记
description: 看 postgresql 中文文档的学习笔记
---  



这是我看 [postgresql 9.3 中文文档](http://58.58.27.50:8079/doc/html/9.3.1_zh/index.html)的笔记，好记性比不过烂笔头啊，哈哈。



##      
## 1. 从头开始      

### 1.2 基本体系概念      

PostgreSQL使用一种 客户端/服务器 的模式。一次PostgreSQL会话由下列相关的进程(程序)组成：

- 一个服务器进程，它管理数据库文件，接受来自客户端应用与数据库的连接，并且代表客 户端在数据库上执行操作。数据库服务器程序叫postgres。   
- 那些需要执行数据库操作的用户的客户端(前端)应用。客户端应用可能本身就是 多种多样的：它们可以是一个字符界面的工具，也可以是一个图形界面的应用， 或者是一个通过访问数据库来显示网页的 web 服务器，或者是一个特殊的数据库 管理工具。一些客户端应用是和PostgreSQL发布一 起提供的，但绝大部分是用户开发的。

和典型的客户端/服务器应用(C/S应用)一样，这些客户端和服务器可以在不同 的主机上。这时它们通过 TCP/IP 网络连接通讯。你应该记住的是，在客户机 上可以访问的文件未必能够在数据库服务器机器上访问(或者只能用不同的文件 名进行访问)。

PostgreSQL服务器可以处理来自客户端的多个并发连接。 因此，它为每个连接启动("forks")一个新的进程。从这个时候开始，客户端和新服务 器进程就不再经过最初的postgres进程进行通讯。因此，主服务器总是在运行，等 待客户端连接，而客户端及其相关联的服务器进程则是起起停停。（当然，用户是肯定看不到 这些事情的。我们在这儿谈这些主要是为了完整。）

PostgreSQL用户名 是和操作系统用户账号分开的。如果你与一个数据库连接，你可以指定以哪个 PostgreSQL用户名进行连接；如果你不指定，那么缺省 就是你当前的操作系统账号。如果这样，那么总有一个与操作系统用户同名的 PostgreSQL用户账号用于启动服务器，并且通常这个用 户都有创建数据库的权限。如果你不想以该用户身份登陆，那么你也可以在任何地方 声明一个-U选项来选择一个连接时使用的PostgreSQL用户名。


### 1.4 访问数据库

两种提示符：

- <database>=> : 一般用户 
- <database>=# ：数据库超级用户

postgresql 内置函数；   
postgresql 里不属于sql的命令：\x, \h，\?, \i 等；

## 2. SQL 语言

postgresql 中 `--` 表示注释；   

```
CREATE TABLE weather (
    city            varchar(80),
    temp_lo         int,           -- low temperature
    temp_hi         int,           -- high temperature
    prcp            real,          -- precipitation
    date            date
);
```

你还可以使用COPY从文本文件中装载大量数据。这么干通常更快， 因为COPY命令就是为这类应用优化的，只是比INSERT 少一些灵活性。比如：

```
COPY weather FROM '/home/user/weather.txt';
```

这里源文件的文件名必须在运行后端进程的那台机器上有效，而不是在客户端上，因为后端进程直接读取这个文件。 你可以在COPY中读到更多有关COPY命令的信息。
select 数据的时候不仅仅可以写字段名，还可以进行一些简单的计算表达式，比如：   

```
SELECT city, (temp_hi+temp_lo)/2 AS temp_avg, date FROM weather;
```

select 后可以直接加数字，表示要查找多少条数据，这也是一种sql优化的方式哦。

```
// 没有效率的：
$r = mysql_query("SELECT * FROM user WHERE country = 'China'");
if (mysql_num_rows($r) > 0) {
    // ...
}
 
// 有效率的：
$r = mysql_query("SELECT 1 FROM user WHERE country = 'China' LIMIT 1");
if (mysql_num_rows($r) > 0) {
    // ...
}
```

### 2.1 表连接  

查询可以一次访问多个表， 或者用某种方式访问一个表，而同时处理该表的多个行。一个同时访问同一个或 者不同表的多个行的查询叫连接查询。
连接有单表内的自连接，多表间的外连接，全连接。

关于表连接，我觉得W3C的这几篇基础教程很好: [w3c sql join](http://www.w3school.com.cn/sql/sql_join.asp)

因为表连接是一件很耗资源的事情，所以在看这章的时候我也看了一篇讲mysql性能优化的文章，虽然不是针对表连接性能分析的，但我觉得也还是挺有用的，推荐一下。[MySQL性能优化的最佳20+条经验](http://coolshell.cn/articles/1846.html)

### 2.2 聚合函数

一个聚合函数从多个输入行中计算出一个结果。比如，我们有在一个行集合上计算count(数目), sum(总和),avg(均值),max(最大值), min(最小值)的函数。

聚合函数不能用于WHERE子句中。存在这个限制是因为WHERE子句决定哪些行可以进入聚合阶段； 因此它必需在聚合函数之前计算。

理解聚合和SQL的WHERE和HAVING 子句之间的关系非常重要。WHERE和HAVING的基本区别如下： WHERE在分组和聚合计算之前选取输入行(它控制哪些行进入聚合计算)， 而HAVING在分组和聚合之后选取输出行。因此，WHERE 子句不能包含聚合函数；因为试图用聚合函数判断那些行将要输入给聚合运算是没有意义的。 相反，HAVING子句总是包含聚合函数。当然，你可以写不使用聚合的HAVING 子句，但这样做没什么好处，因为同样的条件用在WHERE阶段会更有效。 如下：   
这里有常见的几个聚合函数的说明：[SQL Aggregate Functions](http://www.w3schools.com/sql/sql_functions.asp)

```
SELECT city, max(temp_lo)
    FROM weather
    WHERE city LIKE 'S%'(1)
    GROUP BY city
    HAVING max(temp_lo) < 40;
```


## 3. 高级特性  

### 3.2 视图

视图允许我们把表结构的细节封装起来， 这些表可能随你的应用进化而变化，但这些变化却可以隐藏在一个一致的接口后面。
相关语法可以看w3c的教程，[sql view](http://www.w3school.com.cn/sql/sql_view.asp)

### 3.3 外键

SQL的主键和外键的作用：

- 插入非空值时，如果主键表中没有这个值，则不能插入。  
- 更新时，不能改为主键表中没有的值。  
- 删除主键表记录时，你可以在建外键时选定外键记录一起级联删除还是拒绝删除。     
- 更新主键记录时，同样有级联更新和拒绝执行的选择。   

简而言之，SQL的主键和外键就是起约束作用。


主键、外键和索引的区别

- 定义：   
    - 主键--唯一标识一条记录，不能有重复的，不允许为空   
    - 外键--表的外键是另一表的主键, 外键可以有重复的, 可以是空值   
    - 索引--该字段没有重复值，但可以有一个空值   

- 作用：   
    - 主键--用来保证数据完整性  
    - 外键--用来和其他表建立联系用的  
    - 索引--是提高查询排序的速度

- 个数：  
    - 主键--主键只能有一个   
    - 外键--一个表可以有多个外键    
    - 索引--一个表可以有多个唯一索引


例子：

```
CREATE TABLE cities (
        city     varchar(80) primary key,
        location point
);

CREATE TABLE weather (
        city      varchar(80) references cities(city),
        temp_lo   int,
        temp_hi   int,
        prcp      real,
        date      date
);
```

### 3.4 [事务](http://wiki.jikexueyuan.com/project/sql/transactions.html) 

事务是所有数据库系统的一个基本概念。一次事务的要点就是把多个步骤捆绑成一个单一的、 不成功则成仁的操作。其它并发的事务是看不到在这些步骤之间的中间状态的，并且如果发生了一些问题， 导致该事务无法完成，那么所有这些步骤都完全不会影响数据库。

在PostgreSQL里，一个事务是通过把 SQL 命令用BEGIN和COMMIT 命令包围实现的。

PostgreSQL 实际上把每个 SQL 语句当做在一个事务中执行来看待。 如果你没有发出BEGIN命令，那么每个独立的语句都被一个隐含的BEGIN 和(如果成功的话)COMMIT包围。一组包围在BEGIN和COMMIT 之间的语句有时候被称做事务块。


### 3.5 窗口函数  


窗口函数在和当前行相关的一组表行上执行计算。 这相当于一个可以由聚合函数完成的计算类型。但不同于常规的聚合函数， 使用的窗口函数不会导致行被分组到一个单一的输出行；行保留其独立的身份。 在后台，窗口函数能够访问的不止查询结果的当前行。

这里是一个例子，说明如何比较每个员工的工资和在他或她的部门的平均工资：

```
SELECT depname, empno, salary, avg(salary) OVER (PARTITION BY depname) FROM empsalary;

 depname  | empno | salary |          avg          
-----------+-------+--------+-----------------------
 develop   |    11 |   5200 | 5020.0000000000000000
 develop   |     7 |   4200 | 5020.0000000000000000
 develop   |     9 |   4500 | 5020.0000000000000000
 develop   |     8 |   6000 | 5020.0000000000000000
 develop   |    10 |   5200 | 5020.0000000000000000
 personnel |     5 |   3500 | 3700.0000000000000000
 personnel |     2 |   3900 | 3700.0000000000000000
 sales     |     3 |   4800 | 4866.6666666666666667
 sales     |     1 |   5000 | 4866.6666666666666667
 sales     |     4 |   4800 | 4866.6666666666666667
(10 rows)
```

## 4. SQL 语法

### 4.1 词法结构 

- 关键字列表: [sql关键字](http://www.postgres.cn/docs/9.3/sql-keywords-appendix.html)
- 一种好习惯是把关键字写成大写，而名字等用小写：


## 5. 数据定义

### 5.3 约束

约束分类：

- 检查约束：
    - 表约束
    - 字段约束
- 非空约束
- 唯一约束
- 主键：
    从技术上讲，主键约束只是唯一约束和非空约束的组合。
- 外键：
    外键约束声明一个字段(或者一组字段)的数值必须匹配另外一个表中出现的数值。 我们把这个行为称为两个相关表之间的参照完整性。

约束允许你对数据施加任意控制。 如果用户企图在字段里存储违反约束的数据，那么就会抛出一个错误。一个检查约束由一个关键字CHECK后面跟一个放在圆括弧里的表达式组成。 检查约束表达式应该包含受约束的字段，否则这个约束就没什么意义了。

### 5.5 修改表

### 5.6 权限 

### 5.7 模式

模式可以用多种方式组织数据。下面是一些建议使用的模式，它们也很容易在缺省配置中得到支持：

- 如果没有创建任何模式，那么所有用户隐含都访问 public 模式。这样就模拟了没有模式的时候的情景。 这种设置建议主要用在只有一个用户或者数据库里只有几个可信用户的情形。 这样的设置也允许我们平滑地从无模式的环境过渡。

- 你可以为每个用户创建一个模式，名字和用户相同。要记得缺省的搜索路径从$user开始， 它会解析为用户名。因此，如果每个用户都有一个独立的模式，那么他们缺省时访问他们自己的模式。

如果你使用了这样的设置，那么你可能还想撤销对 public 模式的访问(或者删除它)， 这样，用户就真的限制于他们自己的模式了。

- 要安装共享的应用(被所有人使用的表、第三方提供的额外函数等等)， 我们可以把它们放到独立的模式中。只要记得给需要访问它们的用户赋予合适的权限就可以了。 然后用户就可以通过用一个模式名修饰来使用这些额外的对象，或者他们可以把额外的模式放到他们的搜索路径中。

### 5.8 继承

### 5.9 分区

## 6. 数据操作

### 6.1 插入数据  

要一次插入大量数据，可以看看COPY命令。 它不像INSERT命令那么灵活，但是更高效。

### 6.2 更新数据 

这样做可能导致零行、一行或多行数据被更新。 如果我们试图执行一个不匹配任何行的更新，那也不算错。

### 6.3 删除数据

DELETE FROM products WHERE price = 10;





## 相关经验总结

### 1. 临时表的应用



## 参考文档

- [postgresql 9.3 中文文档](http://58.58.27.50:8079/doc/html/9.3.1_zh/index.html)
- [MySQL性能优化的最佳20+条经验](http://coolshell.cn/articles/1846.html)
- [w3c sql join](http://www.w3school.com.cn/sql/sql_join.asp)
- [SQL Aggregate Functions](http://www.w3schools.com/sql/sql_functions.asp)














































